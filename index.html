<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Style AI — Your Personal Fashion Stylist</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut }
             from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, arrayUnion }
             from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    // arrayUnion kept for chatHistory; savedOutfits uses read-modify-write for reliability

    const firebaseConfig = {
      apiKey:            "AIzaSyATioFXuappRhhwJXLgGIWsdmBOZHaN04U",
      authDomain:        "styleai-6cead.firebaseapp.com",
      projectId:         "styleai-6cead",
      storageBucket:     "styleai-6cead.firebasestorage.app",
      messagingSenderId: "963936447508",
      appId:             "1:963936447508:web:537579d399498d8e3f4b01",
      measurementId:     "G-CT8CQ09RZ6"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
      window._authReady = true;
      window._authUser  = user || null;

      if (user) {
        const name = user.displayName || user.email.split('@')[0];
        // Update all user name displays
        document.querySelectorAll('.user-display-name').forEach(el => el.textContent = name);
        document.querySelectorAll('.user-display-email').forEach(el => el.textContent = user.email);

        window._saveOutfit = async (outfitData) => {
          try {
            const ref  = doc(db, "users", user.uid);
            const snap = await getDoc(ref);
            const existing = snap.exists() ? (snap.data().savedOutfits || []) : [];
            const newOutfit = { ...outfitData, savedAt: new Date().toISOString() };
            // Push to end, write whole array back — avoids arrayUnion object equality issues
            await setDoc(ref, { savedOutfits: [...existing, newOutfit] }, { merge: true });
            return true;
          } catch(e) { console.warn("Could not save outfit:", e); return false; }
        };

        window._saveChatMessage = async (role, content) => {
          try {
            const ref = doc(db, "users", user.uid);
            await setDoc(ref, {
              chatHistory: arrayUnion({ role, content, at: new Date().toISOString() })
            }, { merge: true });
          } catch(e) { console.warn("Could not save chat:", e); }
        };

        window._loadSavedOutfits = async () => {
          try {
            const snap = await getDoc(doc(db, "users", user.uid));
            const data = snap.exists() ? snap.data() : {};
            // Return newest-first (reverse of stored order)
            return (data.savedOutfits || []).slice().reverse();
          } catch(e) { console.warn("Load error:", e); return []; }
        };

        window._deleteOutfit = async (displayIndex) => {
          try {
            const snap    = await getDoc(doc(db, "users", user.uid));
            const stored  = snap.exists() ? (snap.data().savedOutfits || []) : [];
            // displayIndex is in reversed (newest-first) order
            // Convert back to stored index: storedIndex = (length - 1) - displayIndex
            const storedIndex = stored.length - 1 - displayIndex;
            if (storedIndex < 0 || storedIndex >= stored.length) return false;
            const updated = stored.filter((_, i) => i !== storedIndex);
            await setDoc(doc(db, "users", user.uid), { savedOutfits: updated }, { merge: true });
            return true;
          } catch(e) { console.warn("Delete failed:", e); return false; }
        };

        // Auto-load dashboard if on it
        if (window._dashboardVisible) window.renderDashboard();

      } else {
        window.location.href = '/login';
      }
    });

    window._fbSignOut = async () => {
      await signOut(auth);
      window.location.href = '/login';
    };
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --ink: #1a1410;
      --parchment: #f5f0e8;
      --cream: #faf7f2;
      --gold: #c9a84c;
      --gold-light: #e8c97a;
      --rose: #c4776a;
      --sage: #7a9b7a;
      --muted: #8c8075;
      --border: rgba(201,168,76,0.25);
      --card-bg: rgba(255,255,255,0.7);
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--cream);
      color: var(--ink);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 998;
      opacity: 0.6;
    }

    /* ── NAV ── */
    nav {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.1rem 2.5rem;
      background: rgba(250,247,242,0.92);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
    }

    .nav-logo {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.4rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .logo-mark {
      width: 28px; height: 28px;
      background: var(--ink);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--gold);
    }

    .nav-tabs {
      display: flex;
      gap: 0.25rem;
      list-style: none;
    }

    .nav-tab {
      padding: 0.55rem 1.1rem;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      cursor: pointer;
      border: none;
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      border-radius: 2px;
      transition: all 0.2s;
      position: relative;
    }

    .nav-tab:hover { color: var(--ink); }

    .nav-tab.active {
      color: var(--ink);
      background: rgba(201,168,76,0.12);
    }

    .nav-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 2px;
      background: var(--gold);
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .nav-user {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .nav-avatar {
      width: 32px; height: 32px;
      background: var(--ink);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--gold);
      font-family: 'Cormorant Garamond', serif;
    }

    .btn-sign-out {
      padding: 0.35rem 0.9rem;
      border: 1px solid var(--border);
      background: transparent;
      font-size: 0.68rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      color: var(--muted);
      transition: all 0.2s;
    }

    .btn-sign-out:hover { border-color: var(--ink); color: var(--ink); }

    /* ── PAGES ── */
    .page { display: none; padding-top: 70px; min-height: 100vh; }
    .page.active { display: block; }

    /* ── HERO (Home) ── */
    .hero {
      min-height: calc(100vh - 70px);
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    .hero-left {
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 5rem 4rem 5rem 5rem;
    }

    .hero-eyebrow {
      font-size: 0.7rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 1.5rem;
    }

    .hero-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(2.8rem, 5vw, 4.2rem);
      font-weight: 300;
      line-height: 1.1;
      margin-bottom: 1.5rem;
    }

    .hero-title em { font-style: italic; color: var(--rose); }

    .hero-sub {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.7;
      max-width: 380px;
      margin-bottom: 2.5rem;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      background: var(--ink);
      color: var(--parchment);
      padding: 1rem 2rem;
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .btn-primary:hover { background: var(--gold); color: var(--ink); transform: translateY(-2px); }

    .hero-right {
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #1a1410 0%, #2d2318 60%, #3d3020 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hero-visual { position: relative; width: 300px; height: 400px; }

    .hero-card {
      position: absolute;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(201,168,76,0.3);
      backdrop-filter: blur(10px);
      border-radius: 2px;
      padding: 1.5rem;
      color: white;
    }

    .hero-card-main {
      width: 240px;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      animation: floatCard 6s ease-in-out infinite;
    }

    @keyframes floatCard {
      0%,100% { transform: translate(-50%, -50%) translateY(0); }
      50% { transform: translate(-50%, -50%) translateY(-12px); }
    }

    .hero-card-mini {
      width: 130px;
      font-size: 0.7rem;
      animation: floatSimple 6s ease-in-out infinite;
    }

    .hero-card-mini-1 { top: 5%; right: -20px; animation-delay: 1s; }
    .hero-card-mini-2 { bottom: 8%; left: -25px; animation-delay: 2s; }

    @keyframes floatSimple {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .tone-swatch {
      width: 48px; height: 48px;
      border-radius: 50%;
      margin-bottom: 0.75rem;
      border: 2px solid rgba(201,168,76,0.4);
    }

    .card-label {
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--gold-light);
      margin-bottom: 0.25rem;
    }

    .card-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      color: white;
    }

    .hero-bg-circles {
      position: absolute;
      width: 400px; height: 400px;
      border-radius: 50%;
      border: 1px solid rgba(201,168,76,0.08);
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      animation: rotateSlow 30s linear infinite;
    }

    .hero-bg-circles::before {
      content: '';
      position: absolute;
      inset: 40px;
      border-radius: 50%;
      border: 1px solid rgba(201,168,76,0.12);
    }

    @keyframes rotateSlow { to { transform: translate(-50%, -50%) rotate(360deg); } }

    /* ── FEATURES on home ── */
    .home-features {
      padding: 6rem 5rem;
      background: var(--parchment);
    }

    .section-header {
      display: flex;
      align-items: baseline;
      gap: 1.5rem;
      margin-bottom: 3.5rem;
    }

    .section-num {
      font-family: 'Cormorant Garamond', serif;
      font-size: 4.5rem;
      font-weight: 300;
      color: var(--border);
      line-height: 1;
    }

    .section-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.2rem;
      font-weight: 300;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
    }

    .feature-item {
      background: var(--cream);
      padding: 2.25rem;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: transform 0.3s;
    }

    .feature-item:hover { transform: translateY(-4px); }

    .feature-item::before {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--gold), transparent);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s;
    }

    .feature-item:hover::before { transform: scaleX(1); }

    .feature-icon { margin-bottom: 1.25rem; display: flex; color: var(--gold); }
    .feature-title { font-family: 'Cormorant Garamond', serif; font-size: 1.2rem; margin-bottom: 0.6rem; }
    .feature-desc { font-size: 0.82rem; color: var(--muted); line-height: 1.6; }

    /* ── ANALYSE PAGE ── */
    .analyse-layout {
      max-width: 1100px;
      margin: 0 auto;
      padding: 3rem 2.5rem;
    }

    .analyse-page-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.4rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
    }

    .analyse-page-sub {
      font-size: 0.88rem;
      color: var(--muted);
      margin-bottom: 2.5rem;
    }

    .analyse-grid {
      display: grid;
      grid-template-columns: 1fr 1.1fr;
      gap: 3rem;
      align-items: start;
    }

    /* Gender & Occasion selectors */
    .selector-label {
      font-size: 0.68rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.6rem;
    }

    .gender-selector {
      display: flex;
      gap: 0;
      margin-bottom: 1.75rem;
    }

    .gender-btn {
      flex: 1;
      padding: 0.8rem 1.25rem;
      border: 1px solid var(--ink);
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.78rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }

    .gender-btn:first-child { border-right: none; }
    .gender-btn.active { background: var(--ink); color: var(--parchment); }

    .occasion-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin-bottom: 1.75rem;
    }

    .occasion-btn {
      padding: 0.6rem 0.4rem;
      border: 1px solid var(--border);
      background: var(--cream);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--muted);
      text-align: center;
      border-radius: 2px;
    }

    .occasion-btn:hover { border-color: var(--gold); color: var(--ink); }
    .occasion-btn.active { background: var(--ink); color: var(--parchment); border-color: var(--ink); }

    .style-input-wrap {
      margin-bottom: 1.75rem;
    }

    .style-input-row {
      display: flex;
      gap: 0.5rem;
    }

    .style-input {
      flex: 1;
      padding: 0.85rem;
      border: 1px solid var(--border);
      background: var(--cream);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .style-input:focus { border-color: var(--gold); }

    .voice-btn {
      padding: 0.85rem 1rem;
      background: var(--ink);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .voice-btn:hover { background: var(--gold); color: var(--ink); }

    .tips-box {
      background: var(--parchment);
      border: 1px solid var(--border);
      padding: 1.1rem 1.25rem;
      font-size: 0.72rem;
      color: var(--muted);
      line-height: 1.9;
    }

    /* Upload zone */
    .upload-zone {
      border: 1.5px dashed rgba(201,168,76,0.5);
      background: var(--parchment);
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      min-height: 280px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--gold);
      background: rgba(201,168,76,0.04);
    }

    .upload-zone h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.4rem;
      font-weight: 400;
    }

    .upload-zone p { font-size: 0.8rem; color: var(--muted); }

    /* Preview */
    .preview-section {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .preview-section.visible { display: flex; }

    .preview-img {
      width: 220px;
      height: 280px;
      object-fit: cover;
      border: 3px solid var(--border);
    }

    .analyse-btn {
      width: 100%;
      max-width: 300px;
      padding: 1rem;
      background: var(--ink);
      color: var(--parchment);
      border: none;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s;
    }

    .analyse-btn:hover { background: var(--gold); color: var(--ink); }
    .analyse-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Loading overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(26,20,16,0.88);
      backdrop-filter: blur(8px);
      z-index: 500;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 2rem;
    }

    .loading-overlay.visible { display: flex; }

    .loading-spinner {
      width: 60px; height: 60px;
      border: 2px solid rgba(201,168,76,0.2);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      color: var(--parchment);
      letter-spacing: 0.1em;
    }

    .loading-sub { font-size: 0.8rem; color: var(--muted); letter-spacing: 0.15em; text-transform: uppercase; }

    /* ── RESULTS PAGE ── */
    .results-layout {
      max-width: 1100px;
      margin: 0 auto;
      padding: 3rem 2.5rem;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2.5rem;
      padding-bottom: 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .results-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.2rem;
      font-weight: 300;
    }

    .results-actions { display: flex; gap: 0.75rem; align-items: center; }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--ink);
      padding: 0.6rem 1.2rem;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.72rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--ink);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .btn-outline:hover { background: var(--ink); color: var(--parchment); }

    .btn-gold {
      border-color: var(--gold);
      color: var(--gold);
    }

    .btn-gold:hover { background: var(--gold); color: var(--ink); }

    .results-grid {
      display: grid;
      grid-template-columns: 270px 1fr;
      gap: 2.5rem;
    }

    /* Skin panel */
    .skin-panel { display: flex; flex-direction: column; gap: 1.25rem; }

    .skin-card {
      background: var(--cream);
      border: 1px solid var(--border);
      padding: 2rem;
      text-align: center;
    }

    .skin-swatch {
      width: 80px; height: 80px;
      border-radius: 50%;
      margin: 0 auto 1rem;
      border: 3px solid rgba(0,0,0,0.08);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }

    .skin-name { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; margin-bottom: 0.25rem; }
    .skin-label { font-size: 0.68rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--muted); }

    .rgb-values { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; }

    .rgb-chip {
      font-size: 0.68rem;
      color: var(--muted);
      background: var(--parchment);
      padding: 0.2rem 0.5rem;
    }

    .palette-card {
      background: var(--cream);
      border: 1px solid var(--border);
      padding: 1.25rem;
    }

    .palette-title { font-size: 0.62rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem; }

    .palette-swatches { display: flex; gap: 0.5rem; }

    .palette-swatch {
      flex: 1; height: 70px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .palette-swatch:hover { transform: translateY(-3px); }

    /* Rec tabs */
    .rec-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1.75rem;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }

    .rec-tab {
      padding: 0.7rem 1.3rem;
      font-size: 0.72rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--muted);
      font-family: 'DM Sans', sans-serif;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .rec-tab.active { color: var(--ink); border-bottom-color: var(--gold); }
    .rec-tab-content { display: none; }
    .rec-tab-content.active { display: block; animation: fadeIn 0.3s ease; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Outfit cards */
    .outfit-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .outfit-card {
      background: var(--cream);
      border: 1px solid var(--border);
      padding: 1.4rem;
    }

    .outfit-card-icon { margin-bottom: 0.6rem; display: flex; color: var(--gold); }
    .outfit-card-title { font-size: 0.62rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--gold); margin-bottom: 0.45rem; }
    .outfit-card-items { list-style: none; }
    .outfit-card-items li { font-size: 0.8rem; color: var(--muted); padding: 0.2rem 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
    .outfit-card-items li:last-child { border: none; }
    .item-label { font-weight: 500; color: var(--ink); font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.06em; }

    .dress-codes { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 1.25rem; }

    .dress-tag { padding: 0.35rem 0.85rem; border: 1px solid var(--border); font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--ink); }

    .suggested-outfit {
      background: var(--cream);
      border-left: 3px solid var(--gold);
      padding: 1rem 1.25rem;
      margin-bottom: 1.25rem;
      font-size: 0.88rem;
      line-height: 1.6;
    }

    .why-box { background: var(--ink); color: var(--parchment); padding: 1.75rem; margin-top: 1rem; }
    .why-label { font-size: 0.62rem; letter-spacing: 0.25em; text-transform: uppercase; color: var(--gold); margin-bottom: 0.65rem; }
    .why-box p { font-family: 'Cormorant Garamond', serif; font-size: 1.05rem; font-style: italic; line-height: 1.6; }

    .acc-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    .acc-item { background: var(--cream); border: 1px solid var(--border); padding: 1rem 1.1rem; font-size: 0.82rem; display: flex; align-items: center; gap: 0.65rem; }
    .acc-num { font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; color: var(--gold); line-height: 1; }

    .hair-card { background: var(--cream); border: 1px solid var(--border); padding: 1.75rem; }
    .hair-style-name { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; margin-bottom: 0.75rem; }
    .hair-how-to { font-size: 0.82rem; color: var(--muted); line-height: 1.7; border-top: 1px solid var(--border); padding-top: 0.75rem; }

    .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
    .shop-card { background: var(--cream); border: 1px solid var(--border); padding: 1.4rem; text-align: center; text-decoration: none; color: var(--ink); display: flex; flex-direction: column; align-items: center; gap: 0.65rem; transition: all 0.3s; }
    .shop-card:hover { border-color: var(--gold); transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .shop-name { font-family: 'Cormorant Garamond', serif; font-size: 1rem; }
    .shop-platform { font-size: 0.62rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); }
    .shop-cta { display: inline-block; padding: 0.35rem 0.9rem; background: var(--ink); color: var(--parchment); font-size: 0.62rem; letter-spacing: 0.1em; text-transform: uppercase; margin-top: 0.2rem; transition: all 0.2s; }
    .shop-card:hover .shop-cta { background: var(--gold); color: var(--ink); }

    /* ── CHAT PAGE ── */
    .chat-layout {
      max-width: 860px;
      margin: 0 auto;
      padding: 3rem 2.5rem;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 70px);
    }

    .chat-page-title { font-family: 'Cormorant Garamond', serif; font-size: 2rem; font-weight: 300; margin-bottom: 0.35rem; }
    .chat-page-sub { font-size: 0.85rem; color: var(--muted); margin-bottom: 1.5rem; }

    .chat-window {
      flex: 1;
      background: var(--parchment);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      font-size: 0.85rem;
      line-height: 1.7;
    }

    .chat-msg-user {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      background: var(--cream);
      border-left: 2px solid var(--ink);
    }

    .chat-msg-ai {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      background: rgba(201,168,76,0.07);
      border-left: 2px solid var(--gold);
    }

    .chat-msg-label {
      font-size: 0.68rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 0.3rem;
      font-weight: 500;
    }

    .chat-input-area {
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
    }

    .chat-input {
      flex: 1;
      padding: 0.8rem 1rem;
      border: 1px solid var(--border);
      background: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      outline: none;
    }

    .chat-input:focus { border-color: var(--gold); }

    .chat-send-btn {
      padding: 0.8rem 1.5rem;
      background: var(--ink);
      color: white;
      border: none;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.78rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      transition: all 0.2s;
    }

    .chat-send-btn:hover { background: var(--gold); color: var(--ink); }

    .quick-chips {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .quick-chip {
      padding: 0.4rem 0.85rem;
      border: 1px solid var(--border);
      background: transparent;
      font-size: 0.72rem;
      cursor: pointer;
      letter-spacing: 0.03em;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .quick-chip:hover { border-color: var(--gold); color: var(--ink); }

    /* ── DASHBOARD PAGE ── */
    .dashboard-layout {
      max-width: 1100px;
      margin: 0 auto;
      padding: 3rem 2.5rem;
    }

    .dash-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .dash-welcome {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.2rem;
      font-weight: 300;
      margin-bottom: 0.3rem;
    }

    .dash-sub { font-size: 0.85rem; color: var(--muted); }

    .dash-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      margin-bottom: 2.5rem;
    }

    .stat-card {
      background: var(--parchment);
      border: 1px solid var(--border);
      padding: 1.5rem 2rem;
    }

    .stat-num {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.8rem;
      font-weight: 300;
      color: var(--gold);
      line-height: 1;
      margin-bottom: 0.35rem;
    }

    .stat-label {
      font-size: 0.68rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .dash-section-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-weight: 300;
      margin-bottom: 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .dash-section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .outfits-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.25rem;
      margin-bottom: 3rem;
    }

    .outfit-saved-card {
      background: var(--cream);
      border: 1px solid var(--border);
      padding: 1.5rem;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .outfit-saved-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }

    .outfit-card-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .outfit-skin-info { display: flex; align-items: center; gap: 0.6rem; }

    .outfit-skin-dot {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      flex-shrink: 0;
    }

    .outfit-skin-tone {
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--gold);
    }

    .outfit-date { font-size: 0.66rem; color: var(--muted); }

    .outfit-delete-btn {
      background: none;
      border: 1px solid var(--border);
      cursor: pointer;
      width: 28px; height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .outfit-delete-btn:hover { border-color: #c0392b; color: #c0392b; }

    .outfit-desc {
      font-size: 0.8rem;
      color: var(--ink);
      line-height: 1.55;
      margin-bottom: 1rem;
      border-left: 2px solid var(--gold);
      padding-left: 0.65rem;
    }

    .outfit-palette-dots { display: flex; gap: 0.35rem; }

    .outfit-dot {
      width: 22px; height: 22px;
      border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.07);
    }

    /* Empty / Loading states */
    .empty-state {
      text-align: center;
      padding: 3.5rem 2rem;
      border: 1px dashed var(--border);
    }

    .empty-state-icon { color: var(--border); margin-bottom: 1rem; display: flex; justify-content: center; }
    .empty-state-title { font-family: 'Cormorant Garamond', serif; font-size: 1.4rem; font-weight: 300; margin-bottom: 0.5rem; }
    .empty-state-sub { font-size: 0.82rem; color: var(--muted); }

    .loading-state {
      text-align: center;
      padding: 2.5rem;
    }

    .mini-spinner {
      width: 28px; height: 28px;
      border: 2px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 0.75rem;
    }

    /* ── TOAST ── */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 0.9rem 1.4rem;
      font-size: 0.82rem;
      z-index: 999;
      display: none;
      animation: slideUp 0.3s ease;
      border-radius: 2px;
    }

    .toast.visible { display: block; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .toast-error { background: #c0392b; color: white; }
    .toast-success { background: var(--sage); color: white; }

    /* ── FOOTER ── */
    footer {
      background: var(--ink);
      color: rgba(255,255,255,0.4);
      text-align: center;
      padding: 1.75rem;
      font-size: 0.72rem;
      letter-spacing: 0.1em;
    }

    footer span { color: var(--gold); }

    /* ── RESPONSIVE ── */
    @media (max-width: 900px) {
      nav { padding: 1rem 1.25rem; }
      .nav-tabs { display: none; }
      .hero { grid-template-columns: 1fr; }
      .hero-right { min-height: 260px; }
      .hero-left { padding: 3rem 1.75rem; }
      .home-features { padding: 4rem 1.75rem; }
      .features-grid { grid-template-columns: 1fr; }
      .analyse-grid { grid-template-columns: 1fr; }
      .results-grid { grid-template-columns: 1fr; }
      .outfit-grid, .acc-grid { grid-template-columns: 1fr; }
      .dash-stats { grid-template-columns: 1fr; }
      .analyse-layout, .results-layout, .dashboard-layout { padding: 2rem 1.25rem; }
    }

    /* Mobile nav tabs for small screens */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 200;
      background: rgba(250,247,242,0.96);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--border);
      padding: 0.5rem 0;
    }

    .mobile-nav-inner {
      display: flex;
      justify-content: space-around;
    }

    .mobile-nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
      padding: 0.4rem 0.75rem;
      font-size: 0.6rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      color: var(--muted);
      transition: color 0.2s;
    }

    .mobile-nav-btn.active { color: var(--gold); }

    @media (max-width: 900px) {
      .mobile-nav { display: block; }
      .page { padding-bottom: 70px; }
    }
  </style>
</head>
<body>

<!-- ── NAV ── -->
<nav>
  <div class="nav-logo" onclick="showPage('home')">
    <div class="logo-mark">✦</div>
    Style AI
  </div>
  <ul class="nav-tabs">
    <li><button class="nav-tab active" data-page="home" onclick="showPage('home')">Home</button></li>
    <li><button class="nav-tab" data-page="analyse" onclick="showPage('analyse')">Analyse</button></li>
    <li><button class="nav-tab" data-page="results" onclick="showPage('results')" id="navResultsBtn" style="display:none;">Results</button></li>
    <li><button class="nav-tab" data-page="chat" onclick="showPage('chat')">Chat</button></li>
    <li><button class="nav-tab" data-page="dashboard" onclick="showPage('dashboard')">Dashboard</button></li>
  </ul>
  <div class="nav-right">
    <div class="nav-user">
      <div class="nav-avatar">✦</div>
      <span class="user-display-name" style="font-size:0.78rem;color:var(--muted);"></span>
    </div>
    <button class="btn-sign-out" onclick="window._fbSignOut && window._fbSignOut()">Sign Out</button>
  </div>
</nav>

<!-- Mobile nav -->
<div class="mobile-nav">
  <div class="mobile-nav-inner">
    <button class="mobile-nav-btn active" data-page="home" onclick="showPage('home')">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </button>
    <button class="mobile-nav-btn" data-page="analyse" onclick="showPage('analyse')">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
      Analyse
    </button>
    <button class="mobile-nav-btn" data-page="chat" onclick="showPage('chat')">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Chat
    </button>
    <button class="mobile-nav-btn" data-page="dashboard" onclick="showPage('dashboard')">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Dashboard
    </button>
  </div>
</div>

<!-- ══════════════════════════════ HOME PAGE ══════════════════════════════ -->
<div class="page active" id="page-home">
  <section class="hero">
    <div class="hero-left">
      <p class="hero-eyebrow">✦ AI-Powered Styling</p>
      <h1 class="hero-title">
        Your personal<br/>
        <em>fashion</em><br/>
        stylist
      </h1>
      <p class="hero-sub">
        Upload a photo and get curated outfit recommendations, colour palettes, and shopping links — all personalised to your unique skin tone using Groq AI.
      </p>
      <button class="btn-primary" onclick="showPage('analyse')">
        Begin your style journey
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>
    <div class="hero-right">
      <div class="hero-bg-circles"></div>
      <div class="hero-visual">
        <div class="hero-card hero-card-main">
          <div class="tone-swatch" style="background: #C4956A;"></div>
          <div class="card-label">Skin Tone Detected</div>
          <div class="card-value">Medium · Olive</div>
        </div>
        <div class="hero-card hero-card-mini hero-card-mini-1">
          <div class="card-label">Palette</div>
          <div style="display:flex;gap:4px;margin-top:6px;">
            <div style="width:20px;height:20px;background:#2C4A7C;border-radius:2px;"></div>
            <div style="width:20px;height:20px;background:#8B6914;border-radius:2px;"></div>
            <div style="width:20px;height:20px;background:#C4956A;border-radius:2px;"></div>
          </div>
        </div>
        <div class="hero-card hero-card-mini hero-card-mini-2">
          <div class="card-label">Top Pick</div>
          <div style="font-size:0.85rem;color:white;margin-top:4px;">Linen Kurta</div>
        </div>
      </div>
    </div>
  </section>

  <section class="home-features">
    <div class="section-header">
      <div class="section-num">01</div>
      <h2 class="section-title">Why Style AI</h2>
    </div>
    <div class="features-grid">
      <div class="feature-item">
        <div class="feature-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </div>
        <h3 class="feature-title">Instant Skin Analysis</h3>
        <p class="feature-desc">Advanced computer vision detects your skin tone from a single photo, categorising it across the Fair–Deep spectrum.</p>
      </div>
      <div class="feature-item">
        <div class="feature-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4"><circle cx="13.5" cy="6.5" r="1.5" fill="currentColor"/><circle cx="17.5" cy="10.5" r="1.5" fill="currentColor"/><circle cx="8.5" cy="7.5" r="1.5" fill="currentColor"/><circle cx="6.5" cy="12.5" r="1.5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>
        </div>
        <h3 class="feature-title">Dynamic Groq AI Analysis</h3>
        <p class="feature-desc">Powered by LLaMA 3.3 70B via Groq, every recommendation is generated live — no static templates, truly personalised styling.</p>
      </div>
      <div class="feature-item">
        <div class="feature-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        </div>
        <h3 class="feature-title">Live Style Chatbot</h3>
        <p class="feature-desc">Ask your personal AI stylist anything — from colour theory and hairstyles to occasion dressing and Indian fashion trends.</p>
      </div>
      <div class="feature-item">
        <div class="feature-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
        </div>
        <h3 class="feature-title">Save Outfit Profiles</h3>
        <p class="feature-desc">Save any analysis to your personal dashboard and revisit your style history anytime. Powered by Firebase Firestore.</p>
      </div>
      <div class="feature-item">
        <div class="feature-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
        </div>
        <h3 class="feature-title">Curated Shopping</h3>
        <p class="feature-desc">Get personalised product picks from Flipkart and Amazon.in — all matched to your skin tone and style profile.</p>
      </div>
      <div class="feature-item">
        <div class="feature-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        </div>
        <h3 class="feature-title">Personal Dashboard</h3>
        <p class="feature-desc">View all your saved outfits in a clean dashboard. Track your style journey over time with skin tone swatches and colour palettes.</p>
      </div>
    </div>
  </section>

  <footer>
    © 2025 <span>Style AI</span> · Powered by Groq LLaMA 3.3 70B · Built with Streamlit & Firebase
  </footer>
</div>

<!-- ══════════════════════════════ ANALYSE PAGE ══════════════════════════════ -->
<div class="page" id="page-analyse">
  <div class="analyse-layout">
    <h1 class="analyse-page-title">Analyse Your Style</h1>
    <p class="analyse-page-sub">Upload a clear photo, set your preferences, and our Groq AI will generate a personalised style profile just for you.</p>

    <div class="analyse-grid">
      <!-- Left: controls -->
      <div>
        <div class="selector-label">Gender</div>
        <div class="gender-selector">
          <button class="gender-btn active" id="genderMale" onclick="setGender('Male', this)">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/></svg>
            Male
          </button>
          <button class="gender-btn" id="genderFemale" onclick="setGender('Female', this)">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M12 16v6M9 19h6"/></svg>
            Female
          </button>
        </div>

        <div class="selector-label">Occasion</div>
        <div class="occasion-grid">
          <button class="occasion-btn active" onclick="setOccasion('Casual', this)">Casual</button>
          <button class="occasion-btn" onclick="setOccasion('Formal', this)">Formal</button>
          <button class="occasion-btn" onclick="setOccasion('Party', this)">Party</button>
          <button class="occasion-btn" onclick="setOccasion('Wedding', this)">Wedding</button>
          <button class="occasion-btn" onclick="setOccasion('Office', this)">Office</button>
          <button class="occasion-btn" onclick="setOccasion('Date Night', this)">Date Night</button>
          <button class="occasion-btn" onclick="setOccasion('Festival', this)">Festival</button>
          <button class="occasion-btn" onclick="setOccasion('Sports', this)">Sports</button>
        </div>

        <div class="style-input-wrap">
          <div class="selector-label">Extra Style Notes (Optional)</div>
          <div class="style-input-row">
            <input type="text" class="style-input" id="stylePrompt" placeholder="e.g. minimalist, bold colours, Korean style…" />
            <button class="voice-btn" onclick="startVoiceInput()" title="Speak your preference">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
            </button>
          </div>
          <p id="voiceStatus" style="font-size:0.72rem;color:var(--gold);margin-top:0.4rem;min-height:1.2rem;"></p>
        </div>

        <div class="tips-box">
          ✦ Use a clear frontal photo for best results<br/>
          ✦ Good lighting improves skin tone accuracy<br/>
          ✦ Supported: PNG, JPG, JPEG, WEBP (max 10MB)<br/>
          ✦ Analysis is powered by Groq LLaMA 3.3 70B
        </div>
      </div>

      <!-- Right: upload / camera -->
      <div>
        <!-- Tab switcher -->
        <div style="display:flex;gap:0;margin-bottom:1rem;border-bottom:1px solid var(--border);">
          <button id="tabUpload" onclick="switchInputTab('upload')" style="flex:1;padding:0.65rem 1rem;border:none;background:transparent;font-family:'DM Sans',sans-serif;font-size:0.72rem;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;color:var(--ink);border-bottom:2px solid var(--gold);font-weight:500;">
            ↑ Upload Photo
          </button>
          <button id="tabCamera" onclick="switchInputTab('camera')" style="flex:1;padding:0.65rem 1rem;border:none;background:transparent;font-family:'DM Sans',sans-serif;font-size:0.72rem;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;">
            ◉ Use Camera
          </button>
        </div>

        <!-- Upload panel -->
        <div id="inputPanelUpload">
          <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(this)" style="display:none;" />
            <div style="color:var(--ink);opacity:0.4;">
              <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
            </div>
            <h3>Click to Upload Your Photo</h3>
            <p>or drag &amp; drop here · PNG, JPG, WEBP up to 10MB</p>
          </div>

          <div class="preview-section" id="previewSection">
            <img id="previewImg" class="preview-img" src="" alt="Your photo" />
            <button class="analyse-btn" id="analyzeBtn" onclick="analyzePhoto()">
              ✦ Analyse My Style with AI
            </button>
            <button onclick="resetUpload()" style="background:transparent;border:none;cursor:pointer;font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);text-decoration:underline;">
              ↩ Choose different photo
            </button>
          </div>
        </div>

        <!-- Camera panel -->
        <div id="inputPanelCamera" style="display:none;">
          <div style="position:relative;background:var(--parchment);border:1.5px dashed rgba(201,168,76,0.5);text-align:center;padding:1rem;min-height:280px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;">
            <video id="cameraStream" autoplay playsinline style="width:100%;max-width:340px;max-height:260px;object-fit:cover;display:none;border:3px solid var(--border);"></video>
            <canvas id="cameraCanvas" style="display:none;"></canvas>
            <div id="cameraPlaceholder" style="color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:0.75rem;">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" opacity="0.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
              <span style="font-size:0.82rem;">Camera preview will appear here</span>
            </div>
            <p id="cameraStatus" style="font-size:0.72rem;color:var(--gold);min-height:1.2rem;"></p>
          </div>
          <div style="display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap;">
            <button id="startCamBtn" onclick="startCamera()" class="analyse-btn" style="flex:1;max-width:none;">
              ◉ Start Camera
            </button>
            <button id="snapBtn" onclick="snapPhoto()" class="analyse-btn" style="flex:1;max-width:none;display:none;background:var(--sage);">
              ✦ Take Snap
            </button>
          </div>
          <div class="preview-section" id="cameraPreviewSection" style="margin-top:1rem;">
            <img id="cameraPreviewImg" class="preview-img" src="" alt="Camera capture" />
            <button class="analyse-btn" id="analyzeCamBtn" onclick="analyzePhoto()">
              ✦ Analyse My Style with AI
            </button>
            <button onclick="resetCamera()" style="background:transparent;border:none;cursor:pointer;font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);text-decoration:underline;">
              ↩ Retake Photo
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════ RESULTS PAGE ══════════════════════════════ -->
<div class="page" id="page-results">
  <div class="results-layout">
    <div class="results-header">
      <h2 class="results-title">Your Style Profile</h2>
      <div class="results-actions">
        <button class="btn-outline btn-gold" id="saveOutfitBtn" onclick="saveCurrentOutfit()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          Save Outfit
        </button>
        <button class="btn-outline" onclick="showPage('analyse')">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.36"/></svg>
          Analyse Another
        </button>
      </div>
    </div>

    <div class="results-grid">
      <!-- Skin panel -->
      <div class="skin-panel">
        <div class="skin-card">
          <div class="skin-swatch" id="skinSwatch"></div>
          <div class="skin-name" id="skinToneName">—</div>
          <div class="skin-label">Skin Tone</div>
          <div class="rgb-values">
            <span class="rgb-chip" id="rgbR">R —</span>
            <span class="rgb-chip" id="rgbG">G —</span>
            <span class="rgb-chip" id="rgbB">B —</span>
          </div>
        </div>
        <div class="palette-card" id="paletteCard" style="display:none;">
          <div class="palette-title">Colour Palette</div>
          <div class="palette-swatches" id="paletteSwatch" style="margin-bottom:1rem;"></div>
          <div id="paletteLabels" style="display:flex;gap:0.5rem;flex-wrap:wrap;"></div>
        </div>
      </div>

      <!-- Tabs panel -->
      <div class="rec-panel">
        <div class="rec-tabs">
          <button class="rec-tab active" onclick="switchTab('outfit', this)">Outfit</button>
          <button class="rec-tab" onclick="switchTab('hair', this)">Hair &amp; Style</button>
          <button class="rec-tab" onclick="switchTab('accessories', this)">Accessories</button>
          <button class="rec-tab" onclick="switchTab('shop', this)">Shop</button>
        </div>

        <div class="rec-tab-content active" id="tab-outfit">
          <div class="selector-label" style="margin-bottom:0.5rem;">Dress Code</div>
          <div class="dress-codes" id="dressCodes"></div>
          <div class="selector-label" style="margin-bottom:0.5rem;">Suggested Outfit</div>
          <div class="suggested-outfit" id="suggestedOutfit"></div>
          <div class="outfit-grid" id="outfitGrid"></div>
          <div class="why-box" id="whyItWorks" style="display:none;">
            <div class="why-label">✦ Why It Works</div>
            <p id="whyText"></p>
          </div>
        </div>

        <div class="rec-tab-content" id="tab-hair">
          <div class="hair-card" id="hairCard">
            <div class="selector-label" style="color:var(--gold);margin-bottom:0.4rem;">Recommended Style</div>
            <div class="hair-style-name" id="hairStyleName">—</div>
            <div class="hair-how-to" id="hairHowTo">—</div>
            <div id="hairExtra" style="margin-top:0.75rem;"></div>
          </div>
        </div>

        <div class="rec-tab-content" id="tab-accessories">
          <div class="acc-grid" id="accGrid"></div>
        </div>

        <div class="rec-tab-content" id="tab-shop">
          <p style="font-size:0.8rem;color:var(--muted);margin-bottom:1.25rem;line-height:1.6;">Curated picks from top Indian retailers — matched to your skin tone.</p>
          <div class="shop-grid" id="shopGrid"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════ CHAT PAGE ══════════════════════════════ -->
<div class="page" id="page-chat">
  <div class="chat-layout">
    <h1 class="chat-page-title">Style Assistant</h1>
    <p class="chat-page-sub">Ask our Groq-powered AI stylist anything — outfits, colours, occasions, trends and more.</p>

    <div class="chat-window">
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg-ai">
          <div class="chat-msg-label" style="color:var(--gold);">Style AI</div>
          Hi! I'm your Style AI assistant powered by Groq LLaMA 3.3. Ask me anything about fashion, outfits, colours, or trends!
        </div>
      </div>
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="chatInput"
          placeholder="Ask anything… e.g. What to wear to a wedding?"
          onkeydown="if(event.key==='Enter') sendChatMessage()" />
        <button class="voice-btn" onclick="startVoiceChat()" title="Voice input" style="padding:0.8rem 1rem;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
        </button>
        <button class="chat-send-btn" onclick="sendChatMessage()">Send</button>
      </div>
    </div>
    <p id="voiceChatStatus" style="font-size:0.72rem;color:var(--gold);margin-top:0.4rem;min-height:1rem;"></p>

    <div class="quick-chips" id="quickChips">
      <div style="font-size:0.72rem;color:var(--muted);font-style:italic;">Loading suggestions…</div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════ DASHBOARD PAGE ══════════════════════════════ -->
<div class="page" id="page-dashboard">
  <div class="dashboard-layout">
    <div class="dash-header">
      <div>
        <div class="dash-welcome">Welcome back, <span class="user-display-name">—</span></div>
        <div class="dash-sub">Your personal style history</div>
      </div>
      <button class="btn-primary" onclick="showPage('analyse')" style="font-size:0.75rem;padding:0.8rem 1.5rem;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New Analysis
      </button>
    </div>

    <!-- Stats -->
    <div class="dash-stats" id="dashStats">
      <div class="stat-card">
        <div class="stat-num" id="statOutfits">—</div>
        <div class="stat-label">Saved Outfits</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="statTone">—</div>
        <div class="stat-label">Skin Tone</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="statLatest">—</div>
        <div class="stat-label">Latest Analysis</div>
      </div>
    </div>

    <!-- Saved Outfits -->
    <div class="dash-section-title">Saved Outfits</div>

    <div id="dashLoading" class="loading-state">
      <div class="mini-spinner"></div>
      <div style="font-size:0.82rem;color:var(--muted);">Loading your style history…</div>
    </div>

    <div id="dashEmpty" class="empty-state" style="display:none;">
      <div class="empty-state-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
      </div>
      <div class="empty-state-title">No saved outfits yet</div>
      <div class="empty-state-sub" style="margin-bottom:1.25rem;">Analyse a photo and click "Save Outfit" to start your style journal.</div>
      <button class="btn-primary" onclick="showPage('analyse')" style="font-size:0.75rem;padding:0.8rem 1.5rem;">
        Analyse a Photo
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>

    <div class="outfits-grid" id="dashOutfitsGrid" style="display:none;"></div>
  </div>
</div>

<!-- ── Loading Overlay ── -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Analysing your style…</div>
  <div class="loading-sub" id="loadingSubText">Powered by Groq LLaMA 3.3</div>
</div>

<!-- ── Toasts ── -->
<div class="toast toast-error" id="toastError"></div>
<div class="toast toast-success" id="toastSuccess"></div>

<script>
/* ════════════════════════════════════════════════════
   STYLE AI — MULTI-PAGE SPA JAVASCRIPT
════════════════════════════════════════════════════ */

let selectedGender  = 'Male';
let selectedOccasion = 'Casual';
let imageBase64     = null;
let chatHistory     = [];
let _lastResultsData = null;
// NOTE: _authReady and _authUser are set on window by the Firebase module above.
// We do NOT redeclare them here to avoid shadowing.
window._dashboardVisible = false;

// Safe defaults until Firebase auth resolves
window._saveOutfit      = async () => false;
window._saveChatMessage = async () => {};
window._loadSavedOutfits = async () => [];
window._deleteOutfit    = async () => false;

/* ── PAGE NAVIGATION ── */
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab, .mobile-nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelectorAll('[data-page="' + name + '"]').forEach(b => b.classList.add('active'));

  // Show results tab in nav only if there are results
  if (name === 'results' && !_lastResultsData) {
    showPage('analyse');
    return;
  }

  if (name === 'dashboard') {
    window._dashboardVisible = true;
    renderDashboard();
  } else {
    window._dashboardVisible = false;
  }

  // Stop camera if navigating away from analyse
  if (name !== 'analyse' && typeof stopCamera === 'function') stopCamera();

  // Load chat suggestions once when visiting chat
  if (name === 'chat' && !window._suggestionsLoaded) {
    window._suggestionsLoaded = true;
    loadChatSuggestions();
  }

  window.scrollTo(0, 0);
}

/* ── GENDER / OCCASION ── */
function setGender(gender, btn) {
  selectedGender = gender;
  document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function setOccasion(occ, btn) {
  selectedOccasion = occ;
  document.querySelectorAll('.occasion-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

/* ── FILE UPLOAD ── */
function handleFileSelect(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    imageBase64 = e.target.result;
    document.getElementById('previewImg').src = imageBase64;
    document.getElementById('uploadZone').style.display = 'none';
    document.getElementById('previewSection').classList.add('visible');
  };
  reader.readAsDataURL(file);
}

function resetUpload() {
  imageBase64 = null;
  document.getElementById('fileInput').value = '';
  document.getElementById('previewImg').src = '';
  document.getElementById('uploadZone').style.display = 'flex';
  document.getElementById('previewSection').classList.remove('visible');
}

/* ── INPUT TAB SWITCHER (Upload / Camera) ── */
function switchInputTab(tab) {
  const isUpload = tab === 'upload';
  document.getElementById('inputPanelUpload').style.display = isUpload ? '' : 'none';
  document.getElementById('inputPanelCamera').style.display = isUpload ? 'none' : '';
  document.getElementById('tabUpload').style.borderBottomColor = isUpload ? 'var(--gold)' : 'transparent';
  document.getElementById('tabUpload').style.color = isUpload ? 'var(--ink)' : 'var(--muted)';
  document.getElementById('tabCamera').style.borderBottomColor = isUpload ? 'transparent' : 'var(--gold)';
  document.getElementById('tabCamera').style.color = isUpload ? 'var(--muted)' : 'var(--ink)';
  if (!isUpload) {
    // Reset any stale preview when switching to camera tab
    document.getElementById('cameraPreviewSection').classList.remove('visible');
    imageBase64 = null;
  } else {
    stopCamera();
  }
}

/* ── CAMERA ── */
let _cameraStream = null;

async function startCamera() {
  const status = document.getElementById('cameraStatus');
  const video  = document.getElementById('cameraStream');
  const placeholder = document.getElementById('cameraPlaceholder');
  try {
    status.textContent = 'Requesting camera access…';
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
    _cameraStream = stream;
    video.srcObject = stream;
    video.style.display = 'block';
    placeholder.style.display = 'none';
    document.getElementById('startCamBtn').style.display = 'none';
    document.getElementById('snapBtn').style.display = '';
    status.textContent = '📸 Camera live — position yourself and tap Take Snap';
  } catch(err) {
    status.textContent = 'Camera access denied or unavailable. ' + (err.message || '');
    console.warn('Camera error:', err);
  }
}

function snapPhoto() {
  const video  = document.getElementById('cameraStream');
  const canvas = document.getElementById('cameraCanvas');
  if (!_cameraStream) return;
  canvas.width  = video.videoWidth  || 640;
  canvas.height = video.videoHeight || 480;
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
  imageBase64 = dataUrl;
  document.getElementById('cameraPreviewImg').src = dataUrl;
  document.getElementById('cameraPreviewSection').classList.add('visible');
  // Pause the video feed
  video.pause();
  document.getElementById('cameraStatus').textContent = '✓ Photo captured — tap Analyse or retake';
  document.getElementById('snapBtn').style.display = 'none';
}

function resetCamera() {
  imageBase64 = null;
  document.getElementById('cameraPreviewSection').classList.remove('visible');
  document.getElementById('cameraPreviewImg').src = '';
  const video = document.getElementById('cameraStream');
  if (_cameraStream) {
    video.play();
    document.getElementById('snapBtn').style.display = '';
    document.getElementById('cameraStatus').textContent = '📸 Camera live — position yourself and tap Take Snap';
  }
}

function stopCamera() {
  if (_cameraStream) {
    _cameraStream.getTracks().forEach(t => t.stop());
    _cameraStream = null;
  }
  const video = document.getElementById('cameraStream');
  if (video) { video.srcObject = null; video.style.display = 'none'; }
  const placeholder = document.getElementById('cameraPlaceholder');
  if (placeholder) placeholder.style.display = 'flex';
  const startBtn = document.getElementById('startCamBtn');
  const snapBtn  = document.getElementById('snapBtn');
  if (startBtn) startBtn.style.display = '';
  if (snapBtn)  snapBtn.style.display  = 'none';
  const status = document.getElementById('cameraStatus');
  if (status) status.textContent = '';
}

/* ── DRAG & DROP ── */
const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) {
    const dt = new DataTransfer();
    dt.items.add(file);
    document.getElementById('fileInput').files = dt.files;
    handleFileSelect(document.getElementById('fileInput'));
  }
});

/* ── ANALYSE ── */
async function analyzePhoto() {
  if (!imageBase64) { showToast('Please upload or capture a photo first.', 'error'); return; }

  // Disable whichever button triggered this
  const btn     = document.getElementById('analyzeBtn');
  const btnCam  = document.getElementById('analyzeCamBtn');
  const btnText = '✦ Analyse My Style with AI';
  if (btn)    { btn.disabled    = true; btn.textContent    = '✦ Analysing…'; }
  if (btnCam) { btnCam.disabled = true; btnCam.textContent = '✦ Analysing…'; }

  const msgs = ['Detecting skin tone…', 'Building your profile with Groq AI…', 'Generating outfit recommendations…', 'Finalising colour palette…'];
  let mi = 0;
  const sub = document.getElementById('loadingSubText');
  const interval = setInterval(() => { if (sub) sub.textContent = msgs[Math.min(mi++, msgs.length - 1)]; }, 1500);

  document.getElementById('loadingOverlay').classList.add('visible');

  try {
    const resp = await fetch('/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        image:    imageBase64,
        gender:   selectedGender,
        occasion: selectedOccasion,
        prompt:   document.getElementById('stylePrompt').value.trim(),
      }),
    });
    const data = await resp.json();
    clearInterval(interval);
    document.getElementById('loadingOverlay').classList.remove('visible');

    if (!data.success) {
      showToast('Analysis failed: ' + (data.error || 'Unknown error'), 'error');
      btn.disabled = false;
      btn.textContent = '✦ Analyse My Style with AI';
      return;
    }

    _lastResultsData = data;
    renderResults(data);
    document.getElementById('navResultsBtn').style.display = '';
    showPage('results');

  } catch(err) {
    clearInterval(interval);
    document.getElementById('loadingOverlay').classList.remove('visible');
    showToast('Connection error: ' + err.message, 'error');
  }

  if (btn)    { btn.disabled    = false; btn.textContent    = btnText; }
  if (btnCam) { btnCam.disabled = false; btnCam.textContent = btnText; }
}

/* ── RENDER RESULTS ── */
// Universal colour resolver — works for ANY name Groq returns.
// Uses CSS colour parsing + a curated map for Indian/fashion-specific names
// that browsers don't know as named colours.
const FASHION_COLORS = {
  // Neutrals browsers don't know
  'ivory':'#FFFFF0','cream':'#FFFDD0','off white':'#FAF9F6','parchment':'#F5F0E8',
  'ecru':'#C2B280','champagne':'#F7E7CE','nude':'#E3BC9A','beige':'#F5F5DC',
  'sand':'#C2B280','linen':'#FAF0E6',
  // Greys
  'charcoal':'#36454F','charcoal grey':'#36454F','ash grey':'#B2BEB5',
  'slate grey':'#708090','off black':'#1C1C1C','jet black':'#0A0A0A',
  // Browns & Indian tones
  'terracotta':'#E2725B','rust orange':'#C0541A','burnt orange':'#CC5500',
  'copper':'#B87333','bronze':'#CD7F32','mocha':'#967969','caramel':'#C68642',
  'chocolate brown':'#7B3F00','taupe':'#483C32','walnut':'#5C4827','ochre':'#CC7722',
  // Reds & Pinks
  'burgundy':'#800020','oxblood':'#4A0000','wine':'#722F37','maroon':'#800000',
  'blush pink':'#F4A7B9','dusty pink':'#DCAE96','dusty rose':'#C9A0A0',
  'rose gold':'#B76E79','hot pink':'#FF69B4','fuchsia':'#FF00FF',
  // Blues
  'navy blue':'#000080','deep navy':'#0A1045','navy':'#000080',
  'royal blue':'#4169E1','cobalt blue':'#0047AB','cobalt':'#0047AB',
  'midnight blue':'#191970','prussian blue':'#003153','denim':'#1560BD',
  'powder blue':'#B0E0E6','baby blue':'#89CFF0','sky blue':'#87CEEB',
  'ocean blue':'#1F75FE','steel blue':'#4682B4',
  // Greens
  'olive green':'#6B7C3F','army green':'#4B5320','hunter green':'#355E3B',
  'bottle green':'#006A4E','pine green':'#01796F','forest green':'#228B22',
  'sage green':'#7A9B7A','emerald green':'#50C878','jade':'#00A36C',
  'mint green':'#98FF98','sea green':'#2E8B57','dark teal':'#003434',
  'pistachio':'#93C572',
  // Purples
  'deep purple':'#673AB7','royal purple':'#7851A9','grape':'#6F2DA8',
  'eggplant':'#614051','plum':'#8B008B','mauve':'#E0B0FF',
  // Yellows & Oranges
  'mustard yellow':'#CFA61D','mustard':'#FFDB58','saffron':'#F4C430',
  'golden yellow':'#FFD700','gold':'#C9A84C','dark gold':'#A8860C',
  // Special Indian
  'mehendi green':'#4B5320','peacock blue':'#005F6A','peacock green':'#00827F',
  'turmeric yellow':'#FFC107','sindoor red':'#FF0000','kumkum':'#8B0000',
};

function colorFromName(rawName) {
  // Strip prefix like "Primary:", "Secondary:", "Accent:" — take everything after last colon
  const name = rawName.split(':').pop().trim().toLowerCase()
    .replace(/[^a-z0-9 ]/g, '').replace(/\s+/g, ' ').trim();

  // 1. Exact match in fashion map
  if (FASHION_COLORS[name]) return FASHION_COLORS[name];

  // 2. Longest partial key match (e.g. "deep navy blue" matches "navy blue")
  let best = '', bestLen = 0;
  for (const key of Object.keys(FASHION_COLORS)) {
    if (name.includes(key) && key.length > bestLen) { best = key; bestLen = key.length; }
  }
  if (best) return FASHION_COLORS[best];

  // 3. Try CSS named colour — attempt with and without spaces
  try {
    const el = document.createElement('div');
    el.style.display = 'none';
    document.body.appendChild(el);

    // Try "navyblue", "dustyrose" etc (no spaces)
    el.style.color = name.replace(/\s+/g, '');
    let computed = window.getComputedStyle(el).color;

    // Try with first word only if multi-word (e.g. "ivory" from "ivory white")
    if ((!computed || computed === 'rgba(0, 0, 0, 0)') && name.includes(' ')) {
      el.style.color = name.split(' ')[0];
      computed = window.getComputedStyle(el).color;
    }

    document.body.removeChild(el);
    if (computed && computed !== 'rgba(0, 0, 0, 0)') {
      const m = computed.match(/\d+/g);
      if (m && m.length >= 3)
        return '#' + [m[0],m[1],m[2]].map(x => parseInt(x).toString(16).padStart(2,'0')).join('');
    }
  } catch(e) {}

  // 4. Fallback — gold accent
  return '#C9A84C';
}

function renderResults(data) {
  const { skin_tone, rgb, recommendations: rec, products } = data;

  // Skin card
  document.getElementById('skinSwatch').style.background = `rgb(${rgb.r},${rgb.g},${rgb.b})`;
  document.getElementById('skinToneName').textContent = skin_tone;
  document.getElementById('rgbR').textContent = 'R ' + rgb.r;
  document.getElementById('rgbG').textContent = 'G ' + rgb.g;
  document.getElementById('rgbB').textContent = 'B ' + rgb.b;

  // Reset palette before rendering (so stale data from prev analysis doesn't persist)
  document.getElementById('paletteCard').style.display = 'none';
  document.getElementById('paletteSwatch').innerHTML = '';
  document.getElementById('paletteLabels').innerHTML = '';

  // Colour palette
  const palette = rec.COLOR_PALETTE || [];
  if (palette.length) {
    const swatchEl = document.getElementById('paletteSwatch');
    const labelsEl = document.getElementById('paletteLabels');
    swatchEl.innerHTML = palette.map(p => {
      const col = colorFromName(p);
      return `<div class="palette-swatch" style="background:${col}" title="${p}"></div>`;
    }).join('');
    labelsEl.innerHTML = palette.map(p => {
      const parts = p.split(':');
      const role  = parts[0]?.trim() || '';
      const name  = parts[1]?.trim() || p;
      return `<span style="font-size:0.62rem;color:var(--muted)">${role ? role + ': ' : ''}<strong style="color:var(--ink)">${name}</strong></span>`;
    }).join('<span style="color:var(--border);margin:0 0.3rem">·</span>');
    document.getElementById('paletteCard').style.display = 'block';
  }

  // Dress codes
  document.getElementById('dressCodes').innerHTML = (rec.DRESS_CODE || [])
    .map(c => `<span class="dress-tag">${escapeHtml(c)}</span>`).join('');

  // Suggested outfit
  document.getElementById('suggestedOutfit').innerHTML =
    (rec.SUGGESTED_OUTFIT || ['No outfit suggestion available.']).map(l => escapeHtml(l)).join('<br/>');

  // Outfit cards grid
  const outfitDetails = [
    { key: 'SHIRT_DETAILS',  label: 'Top / Shirt',  icon: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.57a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.57a2 2 0 0 0-1.34-2.23z"/></svg>' },
    { key: 'PANT_DETAILS',   label: 'Bottom / Pant', icon: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2h12l-2 11-4 9-4-9-2-11z"/></svg>' },
    { key: 'SHOES_DETAILS',  label: 'Shoes',         icon: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 7v4l3 7h12l3-7V7H3z"/><path d="M3 7l3-5h12l3 5"/></svg>' },
  ];

  document.getElementById('outfitGrid').innerHTML = outfitDetails.map(item => {
    const items = (rec[item.key] || []);
    if (!items.length) return '';
    return `
      <div class="outfit-card">
        <div class="outfit-card-icon">${item.icon}</div>
        <div class="outfit-card-title">${item.label}</div>
        <ul class="outfit-card-items">
          ${items.map(i => {
            const parts = i.split(':');
            if (parts.length > 1) {
              return `<li><span class="item-label">${escapeHtml(parts[0].trim())}</span><span>${escapeHtml(parts.slice(1).join(':').trim())}</span></li>`;
            }
            return `<li>${escapeHtml(i)}</li>`;
          }).join('')}
        </ul>
      </div>
    `;
  }).join('');

  // Why it works
  const why = rec.WHY_IT_WORKS || [];
  if (why.length) {
    document.getElementById('whyText').textContent = why.join(' ');
    document.getElementById('whyItWorks').style.display = 'block';
  }

  // Hair tab
  const hair = rec.HAIRSTYLE || [];
  const styleLine = hair.find(l => l.toLowerCase().startsWith('style:'));
  const howLines  = hair.filter(l => !l.toLowerCase().startsWith('style:'));
  document.getElementById('hairStyleName').textContent = styleLine ? styleLine.replace(/style:\s*/i, '') : (hair[0] || '—');
  document.getElementById('hairHowTo').innerHTML = howLines.map(l => escapeHtml(l)).join('<br/>') || '—';

  // Accessories tab
  document.getElementById('accGrid').innerHTML = (rec.ACCESSORIES || []).map((a, i) => `
    <div class="acc-item">
      <div class="acc-num">${String(i + 1).padStart(2, '0')}</div>
      <div style="font-size:0.82rem;color:var(--ink);line-height:1.5;">${escapeHtml(a.replace(/^\d+\.\s*/, ''))}</div>
    </div>
  `).join('') || '<p style="color:var(--muted);font-size:0.82rem;">No accessories data.</p>';

  // Shop tab
  document.getElementById('shopGrid').innerHTML = (products || []).map(p => `
    <a href="${p.url}" target="_blank" class="shop-card">
      <div style="font-size:2.2rem;">${p.icon}</div>
      <div class="shop-name">${escapeHtml(p.name)}</div>
      <div class="shop-platform">${escapeHtml(p.platform)}</div>
      <div class="shop-cta">View →</div>
    </a>
  `).join('');
}

/* ── SAVE OUTFIT ── */
async function saveCurrentOutfit() {
  if (!_lastResultsData) { showToast('Analyse a photo first!', 'error'); return; }
  const btn = document.getElementById('saveOutfitBtn');
  btn.disabled = true;
  btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="animation:spin 0.8s linear infinite;margin-right:0.35rem;vertical-align:middle"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>Saving…';

  // Wait for auth
  let waited = 0;
  while (!window._authReady && waited < 4000) {
    await new Promise(r => setTimeout(r, 100));
    waited += 100;
  }

  if (!window._authUser) {
    btn.disabled = false;
    btn.innerHTML = 'Save Outfit';
    showToast('Please sign in to save outfits.', 'error');
    return;
  }

  const timeout = setTimeout(() => {
    btn.disabled = false;
    btn.innerHTML = 'Save Outfit';
    showToast('Save timed out — check Firestore rules.', 'error');
  }, 8000);

  try {
    const saved = await window._saveOutfit({
      skinTone: _lastResultsData.skin_tone,
      rgb:      _lastResultsData.rgb,
      outfit:   _lastResultsData.recommendations?.SUGGESTED_OUTFIT || [],
      palette:  _lastResultsData.recommendations?.COLOR_PALETTE || [],
      gender:   selectedGender,
      occasion: selectedOccasion,
    });
    clearTimeout(timeout);
    if (saved) {
      showToast('Outfit saved to your dashboard!', 'success');
      btn.innerHTML = '✓ Saved!';
      setTimeout(() => { btn.disabled = false; btn.innerHTML = 'Save Outfit'; }, 2500);
    } else {
      btn.disabled = false;
      btn.innerHTML = 'Save Outfit';
      showToast('Sign in to save outfits.', 'error');
    }
  } catch(err) {
    clearTimeout(timeout);
    btn.disabled = false;
    btn.innerHTML = 'Save Outfit';
    showToast('Save failed: ' + err.message, 'error');
  }
}

/* ── DASHBOARD ── */
window.renderDashboard = async function() {
  const loading = document.getElementById('dashLoading');
  const empty   = document.getElementById('dashEmpty');
  const grid    = document.getElementById('dashOutfitsGrid');

  loading.style.display = 'block';
  empty.style.display   = 'none';
  grid.style.display    = 'none';

  // Wait for auth
  let waited = 0;
  while (!window._authReady && waited < 5000) {
    await new Promise(r => setTimeout(r, 100));
    waited += 100;
  }

  if (!window._authUser) {
    loading.style.display = 'none';
    return;
  }

  try {
    const outfits = await window._loadSavedOutfits();
    loading.style.display = 'none';

    // Update stats
    document.getElementById('statOutfits').textContent = outfits.length;
    if (outfits.length > 0) {
      document.getElementById('statTone').textContent = outfits[0].skinTone || '—';
      const d = new Date(outfits[0].savedAt);
      document.getElementById('statLatest').textContent = d.toLocaleDateString('en-IN', { day:'numeric', month:'short' });
    } else {
      document.getElementById('statTone').textContent = '—';
      document.getElementById('statLatest').textContent = '—';
    }

    if (outfits.length === 0) {
      empty.style.display = 'block';
      return;
    }

    grid.style.display = 'grid';
    grid.innerHTML = outfits.map((o, i) => {
      const date = o.savedAt ? new Date(o.savedAt).toLocaleDateString('en-IN', { day:'numeric', month:'short', year:'numeric' }) : 'Saved';
      const skinColor = o.rgb ? `rgb(${o.rgb.r},${o.rgb.g},${o.rgb.b})` : '#c9a84c';
      const outfitText = (o.outfit || []).join(' ') || 'Style profile saved.';
      const preview = outfitText.length > 110 ? outfitText.substring(0, 110) + '…' : outfitText;
      const palette = (o.palette || []).slice(0, 3);
      const swatches = palette.map(p => {
        const col = colorFromName(p);
        return `<div class="outfit-dot" style="background:${col};" title="${p}"></div>`;
      }).join('');

      return `
        <div class="outfit-saved-card">
          <div class="outfit-card-top">
            <div class="outfit-skin-info">
              <div class="outfit-skin-dot" style="background:${skinColor};"></div>
              <div>
                <div class="outfit-skin-tone">${escapeHtml(o.skinTone || 'Unknown')} Tone</div>
                <div class="outfit-date">${date}${o.occasion ? ' · ' + o.occasion : ''}</div>
              </div>
            </div>
            <button class="outfit-delete-btn" onclick="deleteSavedOutfit(${i}, event)" title="Delete">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
            </button>
          </div>
          <div class="outfit-desc">${escapeHtml(preview)}</div>
          ${swatches ? `
          <div>
            <div style="font-size:0.58rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin-bottom:0.4rem;">Colour Palette</div>
            <div class="outfit-palette-dots">${swatches}</div>
          </div>` : ''}
        </div>
      `;
    }).join('');

  } catch(e) {
    loading.style.display = 'none';
    empty.style.display   = 'block';
    console.warn('Dashboard load error:', e);
  }
};

async function deleteSavedOutfit(index, event) {
  event.stopPropagation();
  const ok = await window._deleteOutfit(index);
  if (ok) {
    showToast('Outfit removed.', 'success');
    renderDashboard();
  } else {
    showToast('Could not delete outfit.', 'error');
  }
}

/* ── CHATBOT ── */
async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;

  const chatBox = document.getElementById('chatMessages');

  chatBox.innerHTML += `
    <div class="chat-msg-user">
      <div class="chat-msg-label" style="color:var(--ink);">You</div>
      ${escapeHtml(message)}
    </div>`;
  input.value = '';
  chatBox.scrollTop = chatBox.scrollHeight;

  if (typeof window._saveChatMessage === 'function') {
    window._saveChatMessage('user', message);
  }

  const typingId = 'typing_' + Date.now();
  chatBox.innerHTML += `<div id="${typingId}" style="padding:0.75rem 1rem;color:var(--muted);font-style:italic;font-size:0.8rem;">Style AI is thinking…</div>`;
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    const resp = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, history: chatHistory }),
    });
    const data = await resp.json();
    const typing = document.getElementById(typingId);
    if (typing) typing.remove();

    const reply = data.reply || 'No response.';
    chatHistory.push({ role:'user', content:message });
    chatHistory.push({ role:'assistant', content:reply });

    chatBox.innerHTML += `
      <div class="chat-msg-ai">
        <div class="chat-msg-label" style="color:var(--gold);">Style AI</div>
        ${escapeHtml(reply)}
      </div>`;

    if (typeof window._saveChatMessage === 'function') {
      window._saveChatMessage('assistant', reply);
    }
  } catch(err) {
    const typing = document.getElementById(typingId);
    if (typing) typing.remove();
    chatBox.innerHTML += `<div style="color:#c0392b;font-size:0.8rem;padding:0.5rem 1rem;margin-bottom:0.75rem;">⚠ Could not connect to server.</div>`;
  }
  chatBox.scrollTop = chatBox.scrollHeight;
}

function quickAsk(msg) {
  document.getElementById('chatInput').value = msg;
  sendChatMessage();
  // Don't call showPage('chat') here — we're already on chat, and it would
  // re-trigger loadChatSuggestions which overwrites the chips mid-flight
}

/* ── DYNAMIC CHAT SUGGESTIONS from Groq ── */
async function loadChatSuggestions() {
  const el = document.getElementById('quickChips');
  if (!el) return;
  try {
    const resp = await fetch('/suggestions');
    const data = await resp.json();
    const chips = data.suggestions || [];
    if (chips.length) {
      el.innerHTML = chips.map(q => {
        const safe = q.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
        return `<button class="quick-chip" data-msg="${safe}">${escapeHtml(q)}</button>`;
      }).join('');
      // Attach click handlers via JS (avoids any inline onclick quoting issues)
      el.querySelectorAll('.quick-chip').forEach(btn => {
        btn.addEventListener('click', () => quickAsk(btn.getAttribute('data-msg')));
      });
    }
  } catch(e) {
    el.innerHTML = '';
  }
}

/* ── VOICE INPUT — inline only, no popup tab ── */
function startVoice(targetInputId, statusId, onResult) {
  const statusEl = document.getElementById(statusId);
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SR) {
    statusEl.textContent = 'Voice not supported in this browser. Try Chrome.';
    setTimeout(() => { statusEl.textContent = ''; }, 3500);
    return;
  }

  const rec = new SR();
  rec.lang = 'en-IN';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  statusEl.textContent = '🎤 Listening…';

  try { rec.start(); } catch(e) {
    statusEl.textContent = 'Could not start mic. Check browser permissions.';
    setTimeout(() => { statusEl.textContent = ''; }, 3500);
    return;
  }

  rec.onresult = e => {
    const t = e.results[0][0].transcript;
    const inp = document.getElementById(targetInputId);
    if (inp) inp.value = t;
    statusEl.textContent = '✓ Got: "' + t + '"';
    setTimeout(() => { statusEl.textContent = ''; }, 3000);
    if (onResult) onResult(t);
  };

  rec.onerror = (e) => {
    const msgs = {
      'not-allowed': 'Mic permission denied. Allow in browser settings.',
      'no-speech':   'No speech detected. Try again.',
      'network':     'Network error during recognition.',
    };
    statusEl.textContent = msgs[e.error] || 'Voice error. Try again.';
    setTimeout(() => { statusEl.textContent = ''; }, 3500);
  };

  rec.onend = () => {
    if (statusEl.textContent === '🎤 Listening…') statusEl.textContent = '';
  };
}

function startVoiceInput() { startVoice('stylePrompt', 'voiceStatus', null); }
function startVoiceChat()  { startVoice('chatInput', 'voiceChatStatus', null); }

/* ── HELPERS ── */
function switchTab(name, btn) {
  document.querySelectorAll('.rec-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.rec-tab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

function escapeHtml(text) {
  if (!text) return '';
  const d = document.createElement('div');
  d.appendChild(document.createTextNode(String(text)));
  return d.innerHTML;
}

function showToast(msg, type) {
  const el = document.getElementById(type === 'error' ? 'toastError' : 'toastSuccess');
  el.textContent = msg;
  el.classList.add('visible');
  setTimeout(() => el.classList.remove('visible'), 3500);
}
</script>
</body>
</html>
